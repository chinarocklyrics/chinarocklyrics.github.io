{%- comment -%}
  Include as: {%- include components/nav/pages.html pages=page_array all=bool -%}
  Depends on: include.pages.
  Results in: HTML for the main navigation when all is nil or false;
    adds links to pages excluded from the main navigation when all is true.
  Includes: components/nav/links.html
  Assigns to:
    nav_parenthood, nav_top_nodes, nav_top_node_titles, nav_ancestors.
{%- endcomment -%}

{%- comment -%}
{% assign nav_parenthood = "" | split: "," %} <!-- Initialize an empty array -->
{% assign new_hash = '{"name": "root", "items": []}' %}
{% assign nav_parenthood = nav_parenthood | push: new_hash %}

{% assign passed_in_pages = include.pages | where_exp: "item", "item.title != nil" %}

{% for page in passed_in_pages %}
  {% if page.parent %}
    {% for parent_value in page.parent %}
      {% assign existing_group = nav_parenthood | where: "name", parent_value | first %}

      {% if existing_group %}
        <!-- Extract existing pages and add the new page -->
        {% assign updated_items = existing_group.items | push: page %}
        
        <!-- Remove old group entry -->
        {% assign nav_parenthood = nav_parenthood | where_exp: "item", "item.name != parent_value" %}

        <!-- Add updated group -->
        {% assign nav_parenthood = nav_parenthood | push: 
          '{"name":"' | append: parent_value | append: '", "items":' | append: updated_items | append: '}' 
        %}
      {% else %}
        <!-- Create a new group for this parent -->
        {% assign new_entry = '{"name":"' | append: parent_value | append: '", "items":[' | append: page | append: ']}' %}
        {% assign nav_parenthood = nav_parenthood | push: new_entry %}
      {% endif %}
    {% endfor %}
  {% else %}
    {% assign parent_value = "root" %}
    {% assign existing_group = nav_parenthood | where: "name", parent_value | first %}

    {% if existing_group %}
      <!-- Extract existing pages and add the new page -->
      {% assign updated_items = existing_group.items | push: page %}
      
      <!-- Remove old group entry -->
      {% assign nav_parenthood = nav_parenthood | where_exp: "item", "item.name != parent_value" %}

      <!-- Add updated group -->
      {% assign nav_parenthood = nav_parenthood | push: 
        '{"name":"' | append: parent_value | append: '", "items":' | append: updated_items | append: '}' 
      %}
    {% else %}
      <!-- Create a new group for this parent -->
      {% assign new_entry = '{"name":"' | append: parent_value | append: '", "items":[' | append: page | append: ']}' %}
      {% assign nav_parenthood = nav_parenthood | push: new_entry %}
    {% endif %}
  {% endif %}
{% endfor %}
{%- endcomment -%}

{% assign all_pages = include.pages | where_exp: "item", "item.title != nil" %}
{% assign grouped_pages = "" %} <!-- Capture empty string initially -->

{% for page in all_pages %}
  {% if page.parent %}
    {% if page.parent.size > 1 %}
      {% assign parent_list = page.parent %}
      {% for parent in parent_list %}
        {% capture parent_key %}{{ parent }}{% endcapture %}
        {% assign grouped_pages = grouped_pages | append: parent_key | append: ":" %}
        {% capture page_item %}{{ page.url }}|{{ page.title }}{% endcapture %}
        {% assign grouped_pages = grouped_pages | append: page_item | append: "," %}
      {% endfor %}
    {% else %}
      {% capture parent_key %}{{ page.parent }}{% endcapture %}
      {% assign grouped_pages = grouped_pages | append: parent_key | append: ":" %}
      {% capture page_item %}{{ page.url }}|{{ page.title }}{% endcapture %}
      {% assign grouped_pages = grouped_pages | append: page_item | append: "," %}
    {% endif %}
  {% else %}
    {% capture parent_key %}{% endcapture %}
    {% assign grouped_pages = grouped_pages | append: parent_key | append: ":" %}
    {% capture page_item %}{{ page.url }}|{{ page.title }}{% endcapture %}
    {% assign grouped_pages = grouped_pages | append: page_item | append: "," %}
  {% endif %}
{% endfor %}

<!-- Parse the grouped_pages string into the actual hash structure -->
{% assign nav_parenthood = ""  | split: "|"  %}
{% for item in grouped_pages | split: "," %}
  {% assign parts = item | split: ":" %}
  {% assign parent = parts[0] %}
  {% assign page_info = parts[1] | split: "|" %}
  {% assign page_url = page_info[0] %}
  {% assign page_title = page_info[1] %}

  {% if nav_parenthood[parent] %}
    {% assign nav_parenthood[parent] = nav_parenthood[parent] | push: { "url": page_url, "title": page_title } %}
  {% else %}
    {% assign nav_parenthood[parent] = [{ "url": page_url, "title": page_title }] %}
  {% endif %}
{% endfor %}

{% comment %}
  Now `grouped_pages` contains the pages grouped by parent value,
  even when some pages have multiple parents or an empty parent value.
{% endcomment %}


<pre>
  {{ nav_parenthood | inspect}}
</pre>

{% for item in nav_parenthood %}
   {{ item.name | inspect }}
{% endfor %}

{%- assign nav_top_nodes = nav_parenthood
      | where_exp: "item", "item.name == ''" | map: "items" | first -%}

{%- include components/nav/sorted.html pages=nav_top_nodes -%}

{% assign nav_top_node_titles = nav_top_nodes | map: "title" -%}

{%- assign nav_ancestors = "" | split: "" -%}

{%- include components/nav/links.html pages=nav_sorted ancestors=nav_ancestors all=include.all -%}
